<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Notes for LMS App.js</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f7f9;
        }
        .note-container {
            border: 1px solid #ccc;
            padding: 15px;
            background-color: #fff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .header h2 {
            margin: 0;
            color: #333;
        }
        .button-group button {
            padding: 8px 15px;
            margin-left: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .copy-btn {
            background-color: #007bff;
            color: white;
        }
        .copy-btn:hover {
            background-color: #0056b3;
        }
        .download-btn {
            background-color: #28a745;
            color: white;
        }
        .download-btn:hover {
            background-color: #1e7e34;
        }
        /* Style for the TEXTAREA to look like a code block */
        #code-display {
            width: 100%;
            height: 740px; /* Fixed height for scrollability */
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
            background-color: #f8f8f8;
            box-sizing: border-box;
            resize: none; /* Prevent manual resizing */
            overflow: auto;
        }
    </style>
</head>
<body>

<div class="note-container">
    <div class="header">
        <h2>üìù Library Management System JavaScript (app.js)</h2>
        <div class="button-group">
            <button class="copy-btn" id="copyButton">üìã Copy Code</button>
            <button class="download-btn" id="downloadButton">‚¨áÔ∏è Download app.js</button>
        </div>
    </div>

    <textarea id="code-display" readonly>// ==========================================================
// CONFIGURATION & DOM ELEMENTS
// ==========================================================

// !! CRITICAL FIX: Ensure this is 3000 to match server.js
const BASE_URL = 'http://127.0.0.1:3000/api'; 

// Form IDs
const publisherForm = document.getElementById('publisherForm');
const bookForm = document.getElementById('bookForm');
const authorForm = document.getElementById('authorForm');
const branchForm = document.getElementById('branchForm');
const copiesForm = document.getElementById('copiesForm');
const cardForm = document.getElementById('cardForm');
const lendingForm = document.getElementById('lendingForm');

// ==========================================================
// A. SECTION TOGGLE & NAVIGATION LOGIC 
// ==========================================================

function showSection(sectionId) {
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
    });
    document.getElementById(sectionId).classList.add('active');

    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    const targetBtn = document.querySelector(`.nav-btn[onclick="showSection('${sectionId}')"]`);
    if(targetBtn) {
        targetBtn.classList.add('active');
    }
}

function getCurrentSectionId() {
    const activeSection = document.querySelector('.section.active');
    return activeSection ? activeSection.id : 'dashboard'; 
}

function reShowCurrentSection() {
    // Adding a small delay helps ensure the server has time to process the delete/insert 
    setTimeout(() => {
        const currentSectionId = getCurrentSectionId(); 
        initializeApp();        
        showSection(currentSectionId); 
    }, 100); 
}

// ==========================================================
// B. DATA FETCHING AND DISPLAY 
// ==========================================================

function getDeleteKeys(tableId, record) {
    switch (tableId) {
        case 'publishersTable':
            return { keys: [record.NAME], route: 'publishers' };
        case 'booksTable':
            return { keys: [record.BOOK_ID], route: 'books' };
        case 'branchesTable':
            return { keys: [record.BRANCH_ID], route: 'branches' };
        case 'cardsTable':
            return { keys: [record.CARD_NO], route: 'cards' };
        case 'copiesTable': 
            // Keys must be BOOK_ID and BRANCH_ID, which are returned by the server
            return { keys: [record.BOOK_ID, record.BRANCH_ID], route: 'book_copies' };
        default:
            return null;
    }
}

async function fetchAndRenderTable(apiUrl, tableId, columnsArray) {
    const tableBody = document.querySelector(`#${tableId} tbody`);
    // Check if tableBody exists before trying to access innerHTML
    if (!tableBody) {
        console.error(`Table body element with ID #${tableId} tbody not found in HTML.`);
        return;
    }
    tableBody.innerHTML = '<tr><td colspan="100%">Loading...</td></tr>'; 

    try {
        const response = await fetch(apiUrl);
        if (!response.ok) {
            const errorDetails = await response.text();
            // This displays the error you were seeing (e.g., 404 or 500)
            tableBody.innerHTML = `<tr><td colspan="100%" style="color:red; font-weight: bold;">
                Error fetching data: HTTP error status: ${response.status} - ${errorDetails.substring(0, 100)}...
            </td></tr>`;
            console.error(`Fetch Error (${tableId}):`, errorDetails);
            return;
        }
        const records = await response.json();

        if (records.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="100%">No records found.</td></tr>';
            return;
        }

        const deletable = getDeleteKeys(tableId, {});
        
        // Dynamic Header Check 
        const headerRow = document.querySelector(`#${tableId} thead tr`);
        if (headerRow) {
            let headerHtml = columnsArray.map(col => `<th>${col}</th>`).join('');
            if (deletable) {
                headerHtml += '<th>Actions</th>';
            }
            headerRow.innerHTML = headerHtml;
        }


        let html = '';
        records.forEach(record => {
            html += '<tr>';
            columnsArray.forEach(key => { 
                const value = record[key] === null || record[key] === undefined ? '' : record[key];
                html += `<td>${value}</td>`; 
            });

            // ADD DELETE BUTTON CELL
            if (deletable) {
                const deleteKeys = getDeleteKeys(tableId, record);
                
                // CRITICAL: Encode parameters for URL safety 
                const encodedParams = deleteKeys.keys.map(key => encodeURIComponent(key)).join('/');
                
                html += `<td><button class="delete-btn" onclick="deleteRecord('${deleteKeys.route}', '${encodedParams}')">Delete</button></td>`;
            }

            html += '</tr>';
        });

        tableBody.innerHTML = html;

    } catch (error) {
        console.error(`Failed to fetch data for ${tableId}:`, error);
        tableBody.innerHTML = `<tr><td colspan="100%" style="color:red;">Error fetching data: ${error.message}</td></tr>`;
    }
}

async function loadDashboardStats() {
    const statsGrid = document.getElementById('statsGrid');
    if (!statsGrid) return;
    statsGrid.innerHTML = '';
    try {
        const response = await fetch(`${BASE_URL}/stats`);
        const stats = await response.json();

        const data = [
            { label: 'Total Books', value: stats.totalBooks },
            { label: 'Total Branches', value: stats.totalBranches },
            { label: 'Total Cards', value: stats.totalCards }
        ];

        data.forEach(stat => {
            statsGrid.innerHTML += `
                <div class="stat-card">
                    <div class="stat-number">${stat.value}</div>
                    <div class="stat-label">${stat.label}</div>
                </div>
            `;
        });
        
        fetchAndRenderTable(`${BASE_URL}/lendings`, 'recentLendings', ['BookTitle', 'BranchName', 'CARD_NO', 'DATE_OUT', 'DUE_DATE']);

    } catch (error) {
        console.error('Failed to load dashboard stats:', error);
        statsGrid.innerHTML = '<p style="color: red;">Failed to load stats.</p>';
    }
}

// ==========================================================
// C. FORM SUBMISSION HANDLER
// ==========================================================

async function handleSubmission(e, formElement, apiUrl, resetForm = true) {
    e.preventDefault();

    const formId = formElement.id;
    let inputs = {};

    // Map frontend IDs to backend keys (uses TEXT INPUTS from the correct HTML)
    switch (formId) {
        case 'publisherForm':
            inputs.name = document.getElementById('publisherName').value;
            inputs.phone = document.getElementById('publisherPhone').value;
            inputs.address = document.getElementById('publisherAddress').value;
            break;
        case 'bookForm':
            inputs.bookId = document.getElementById('bookId').value;
            inputs.title = document.getElementById('bookTitle').value;
            inputs.pubYear = document.getElementById('pubYear').value;
            inputs.publisherName = document.getElementById('bookPublisher').value; // <--- Reads from text input
            break;
        case 'authorForm':
            inputs.authorName = document.getElementById('authorName').value;
            inputs.bookId = document.getElementById('authorBookId').value;
            break;
        case 'branchForm':
            inputs.branchId = document.getElementById('branchId').value;
            inputs.branchName = document.getElementById('branchName').value;
            inputs.branchAddress = document.getElementById('branchAddress').value;
            break;
        case 'copiesForm':
            inputs.noOfCopies = document.getElementById('copyCount').value;
            inputs.bookId = document.getElementById('copyBookId').value;
            inputs.branchId = document.getElementById('copyBranchId').value;
            break;
        case 'cardForm':
            inputs.cardNo = document.getElementById('cardNo').value;
            break;
        case 'lendingForm':
            inputs.dateOut = document.getElementById('dateOut').value;
            inputs.dueDate = document.getElementById('dueDate').value;
            inputs.bookId = document.getElementById('lendingBookId').value;
            inputs.branchId = document.getElementById('lendingBranchId').value;
            inputs.cardNo = document.getElementById('lendingCardNo').value;
            break;
        default:
            return;
    }

    try {
        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(inputs) 
        });

        const responseText = await response.text();
        let data = { message: "Operation successful." };
        
        try { 
            data = JSON.parse(responseText); 
        } catch (e) {
             // If response is not JSON (e.g., a raw HTML 500 error), alert the raw status
            if (!response.ok) {
                alert(`Failed: ${response.status} ${response.statusText}. Check server console.`);
                return;
            }
        }

        if (response.ok) {
            alert('Success: ' + (data.message || 'Record added successfully!'));
            if (resetForm) formElement.reset();
            
            reShowCurrentSection(); 
        } else {
            // Display the specific MySQL error or custom message
            const errorMsg = data.sqlMessage || data.message || response.statusText || 'Server error occurred.';
            alert(`Failed: Database Error: ${errorMsg}`);
        }
    } catch (error) {
        console.error('Submission Error:', error);
        alert('Could not connect to server or process data.');
    }
}

// ==========================================================
// D. DELETE HANDLER 
// ==========================================================

async function deleteRecord(route, params) {
    if (!confirm(`Are you sure you want to delete the record for ${route} with key(s): ${params}? This action is irreversible.`)) {
        return;
    }

    const apiUrl = `${BASE_URL}/${route}/${params}`;

    try {
        const response = await fetch(apiUrl, {
            method: 'DELETE',
        });

        if (response.ok) {
            alert('Success: Record deleted successfully!');
            reShowCurrentSection();
        } else {
            const errorText = await response.text();
            let errorMsg = `Failed to delete record: ${response.status} ${response.statusText}`;
            try {
                const data = JSON.parse(errorText);
                errorMsg = data.sqlMessage || data.message || errorMsg;
            } catch (e) {
                // Use default message if response is not JSON
            }
            alert(`Delete Failed: ${errorMsg}`);
        }
    } catch (error) {
        console.error('Delete Error:', error);
        alert('Could not connect to server to execute delete operation.');
    }
}


// --- Attach Handlers to Forms ---
publisherForm.addEventListener('submit', (e) => handleSubmission(e, publisherForm, `${BASE_URL}/publishers`));
bookForm.addEventListener('submit', (e) => handleSubmission(e, bookForm, `${BASE_URL}/books`));
authorForm.addEventListener('submit', (e) => handleSubmission(e, authorForm, `${BASE_URL}/authors`));
branchForm.addEventListener('submit', (e) => handleSubmission(e, branchForm, `${BASE_URL}/branches`));
copiesForm.addEventListener('submit', (e) => handleSubmission(e, copiesForm, `${BASE_URL}/book_copies`));
cardForm.addEventListener('submit', (e) => handleSubmission(e, cardForm, `${BASE_URL}/cards`));
lendingForm.addEventListener('submit', (e) => handleSubmission(e, lendingForm, `${BASE_URL}/lendings`));


// ==========================================================
// E. INITIALIZATION
// ==========================================================

function initializeApp() {
    // Load Tables
    fetchAndRenderTable(`${BASE_URL}/publishers`, 'publishersTable', ['NAME', 'PHONE', 'ADDRESS']);
    fetchAndRenderTable(`${BASE_URL}/books`, 'booksTable', ['BOOK_ID', 'TITLE', 'PUB_YEAR', 'PUBLISHER_NAME', 'Authors']);
    fetchAndRenderTable(`${BASE_URL}/branches`, 'branchesTable', ['BRANCH_ID', 'BRANCH_NAME', 'ADDRESS']);
    fetchAndRenderTable(`${BASE_URL}/book_copies`, 'copiesTable', ['NO_OF_COPIES', 'BookTitle', 'BranchName']);
    fetchAndRenderTable(`${BASE_URL}/cards`, 'cardsTable', ['CARD_NO']);
    
    // Load Dashboard
    loadDashboardStats();
}

document.addEventListener('DOMContentLoaded', () => {
    showSection('dashboard'); 
    initializeApp();
});</textarea>
</div>

<script>
    const codeDisplay = document.getElementById('code-display');
    const copyButton = document.getElementById('copyButton');
    const downloadButton = document.getElementById('downloadButton');

    // **1. Copy Code Functionality**
    copyButton.addEventListener('click', () => {
        // Select the content of the textarea
        codeDisplay.select(); 
        codeDisplay.setSelectionRange(0, 99999); // For mobile devices

        // Use the modern Clipboard API (preferred)
        navigator.clipboard.writeText(codeDisplay.value).then(() => {
            copyButton.textContent = '‚úÖ Copied!';
            setTimeout(() => {
                copyButton.textContent = 'üìã Copy Code';
            }, 2000);
        }).catch(err => {
            console.error('Could not copy text: ', err);
            copyButton.textContent = '‚ùå Failed!';
            setTimeout(() => {
                copyButton.textContent = 'üìã Copy Code';
            }, 2000);
        });
    });

    // **2. Download JS Functionality**
    downloadButton.addEventListener('click', () => {
        // Get the code content from the textarea's value
        const codeContent = codeDisplay.value;
        
        // Create a Blob from the content with the JavaScript file type
        const blob = new Blob([codeContent], { type: 'application/javascript' });
        
        // Create a temporary link element
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        
        // Set the link attributes for download
        a.href = url;
        a.download = 'app.js'; // Suggested filename for the user
        
        // Programmatically click the link to trigger the download
        document.body.appendChild(a);
        a.click();
        
        // Clean up the temporary link and object URL
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        downloadButton.textContent = '‚¨áÔ∏è Downloading...';
        setTimeout(() => {
            downloadButton.textContent = '‚¨áÔ∏è Download app.js';
        }, 2000);
    });
</script>

</body>
</html>